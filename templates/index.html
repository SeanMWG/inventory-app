<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Hardware Inventory</title>
    <link rel="stylesheet" href="static/styles.css">
    <!-- AG Grid Community Edition -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@29.3.5/styles/ag-grid.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@29.3.5/styles/ag-theme-alpine.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@29.3.5/styles/ag-theme-alpine-dark.min.css">
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@29.3.5/dist/ag-grid-community.min.js"></script>
</head>
<body>
    <!-- Previous HTML content remains the same until details modal -->

    <!-- Details Modal -->
    <div id="detailsModal" class="details-modal">
        <div class="details-content">
            <span class="close">&times;</span>
            <h2>Hardware Details</h2>
            <div class="details-grid">
                <div class="details-item">
                    <div class="details-label">Site Name</div>
                    <div class="details-value" id="detailSiteName"></div>
                </div>
                <div class="details-item">
                    <div class="details-label">Room Number</div>
                    <div class="details-value" id="detailRoomNumber"></div>
                </div>
                <div class="details-item">
                    <div class="details-label">Room Name</div>
                    <div class="details-value" id="detailRoomName"></div>
                </div>
                <div class="details-item">
                    <div class="details-label">Asset Tag</div>
                    <div class="details-value" id="detailAssetTag"></div>
                </div>
                <div class="details-item">
                    <div class="details-label">Asset Type</div>
                    <div class="details-value" id="detailAssetType"></div>
                </div>
                <div class="details-item">
                    <div class="details-label">Model</div>
                    <div class="details-value" id="detailModel"></div>
                </div>
                <div class="details-item">
                    <div class="details-label">Serial Number</div>
                    <div class="details-value" id="detailSerialNumber"></div>
                </div>
                <div class="details-item">
                    <div class="details-label">Notes</div>
                    <div class="details-value" id="detailNotes"></div>
                </div>
                <div class="details-item">
                    <div class="details-label">Assigned To</div>
                    <div class="details-value" id="detailAssignedTo"></div>
                </div>
                <div class="details-item">
                    <div class="details-label">Date Assigned</div>
                    <div class="details-value" id="detailDateAssigned"></div>
                </div>
                <div class="details-item">
                    <div class="details-label">Date Decommissioned</div>
                    <div class="details-value" id="detailDateDecommissioned"></div>
                </div>
            </div>
            <div class="details-actions">
                <button class="view-audit-button" id="viewAuditButton">View History</button>
                <button class="edit-button" id="detailsEditButton">Edit</button>
                <button class="loaner-button" id="toggleLoanerButton">Mark as Loaner</button>
            </div>
        </div>
    </div>

    <!-- Rest of HTML content remains the same -->

    <script>
        // Previous JavaScript code remains the same until columnDefs

        // Column Definitions with Community Edition features
        const columnDefs = [
            { 
                field: 'site_name', 
                headerName: 'Site Name',
                sortable: true,
                filter: true,
                resizable: true
            },
            { 
                field: 'room_name',
                headerName: 'Room Name',
                sortable: true,
                filter: true,
                resizable: true
            },
            { 
                field: 'room_number',
                headerName: 'Room Number',
                sortable: true,
                filter: true,
                resizable: true
            },
            { 
                field: 'asset_tag',
                headerName: 'Asset Tag',
                sortable: true,
                filter: true,
                resizable: true
            },
            { 
                field: 'asset_type',
                headerName: 'Asset Type',
                sortable: true,
                filter: true,
                resizable: true
            },
            { 
                field: 'model',
                headerName: 'Model',
                sortable: true,
                filter: true,
                resizable: true
            },
            { 
                field: 'serial_number',
                headerName: 'Serial Number',
                sortable: true,
                filter: true,
                resizable: true
            },
            { 
                field: 'notes',
                headerName: 'Notes',
                sortable: true,
                filter: true,
                resizable: true
            },
            { 
                field: 'assigned_to',
                headerName: 'Assigned To',
                sortable: true,
                filter: true,
                resizable: true
            },
            { 
                field: 'date_assigned',
                headerName: 'Date Assigned',
                sortable: true,
                filter: true,
                resizable: true
            },
            { 
                field: 'date_decommissioned',
                headerName: 'Date Decommissioned',
                sortable: true,
                filter: true,
                resizable: true
            },
            {
                field: 'is_loaner',
                headerName: 'Loaner',
                sortable: true,
                filter: true,
                resizable: true,
                cellRenderer: params => params.value ? 'Yes' : 'No'
            },
            {
                headerName: 'Actions',
                field: 'actions',
                sortable: false,
                filter: false,
                pinned: 'right',
                width: 100,
                cellRenderer: (params) => {
                    const editBtn = document.createElement('button');
                    editBtn.innerHTML = 'Edit';
                    editBtn.classList.add('edit-button');
                    editBtn.addEventListener('click', (event) => {
                        event.stopPropagation(); // Stop event from bubbling up to row
                        editHardware(params.data);
                    });
                    return editBtn;
                }
            }
        ];

        // Previous JavaScript code remains the same until showDetails function

        function showDetails(item) {
            currentItem = item;
            
            // Update details view
            document.getElementById('detailSiteName').textContent = item.site_name || '';
            document.getElementById('detailRoomNumber').textContent = item.room_number || '';
            document.getElementById('detailRoomName').textContent = item.room_name || '';
            document.getElementById('detailAssetTag').textContent = item.asset_tag || '';
            document.getElementById('detailAssetType').textContent = item.asset_type || '';
            document.getElementById('detailModel').textContent = item.model || '';
            document.getElementById('detailSerialNumber').textContent = item.serial_number || '';
            document.getElementById('detailNotes').textContent = item.notes || '';
            document.getElementById('detailAssignedTo').textContent = item.assigned_to || '';
            document.getElementById('detailDateAssigned').textContent = item.date_assigned ? new Date(item.date_assigned).toLocaleDateString() : '';
            document.getElementById('detailDateDecommissioned').textContent = item.date_decommissioned ? new Date(item.date_decommissioned).toLocaleDateString() : '';
            
            // Update loaner button text
            const loanerButton = document.getElementById('toggleLoanerButton');
            loanerButton.textContent = item.is_loaner ? 'Remove Loaner Status' : 'Mark as Loaner';
            
            // Show the details modal
            document.getElementById('detailsModal').style.display = 'block';
            
            // Set up button click handlers
            document.getElementById('viewAuditButton').onclick = () => loadAuditLog(item.asset_tag);
            document.getElementById('detailsEditButton').onclick = () => editHardware(item);
            document.getElementById('toggleLoanerButton').onclick = () => toggleLoaner(item);
        }

        // Add toggleLoaner function
        async function toggleLoaner(item) {
            try {
                const response = await fetch(`/api/hardware/${item.asset_tag}/toggle-loaner`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to toggle loaner status');
                }

                const result = await response.json();
                
                // Update the button text based on the new state
                const button = document.getElementById('toggleLoanerButton');
                button.textContent = result.is_loaner ? 'Remove Loaner Status' : 'Mark as Loaner';
                
                // Reload the grid to reflect the change
                loadInventory(currentPage);
                
                alert(result.is_loaner ? 'Marked as loaner' : 'Removed loaner status');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Rest of JavaScript code remains the same
    </script>
</body>
</html>
