<!DOCTYPE html>
<html>
<head>
    <title>MWG Inventory Management</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://unpkg.com/ag-grid-community/styles/ag-grid.css" rel="stylesheet">
    <link href="https://unpkg.com/ag-grid-community/styles/ag-theme-alpine.css" rel="stylesheet">
    <script src="https://unpkg.com/ag-grid-community/dist/ag-grid-community.min.noStyle.js"></script>
</head>
<body>
    <div class="container">
        <div class="top-buttons">
            <div class="user-info">
                <span class="user-role">Admin</span>
            </div>
            <button class="theme-toggle" onclick="App.toggleTheme()">
                <span class="theme-icon">🌙</span>
                <span class="theme-text">Dark Mode</span>
            </button>
        </div>

        <div class="action-buttons">
            <button class="action-button" onclick="App.showAddModal()">Add Hardware</button>
            <button class="action-button" onclick="App.toggleFilterPanel()">Filters</button>
        </div>

        <div class="filter-panel" id="filterPanel">
            <div class="filter-grid">
                <div class="filter-group">
                    <label>Site Name:</label>
                    <input type="text" id="filterSiteName">
                </div>
                <div class="filter-group">
                    <label>Room Number:</label>
                    <input type="text" id="filterRoomNumber">
                </div>
                <div class="filter-group">
                    <label>Asset Tag:</label>
                    <input type="text" id="filterAssetTag">
                </div>
                <div class="filter-group">
                    <label>Asset Type:</label>
                    <input type="text" id="filterAssetType">
                </div>
                <div class="filter-group">
                    <label>Model:</label>
                    <input type="text" id="filterModel">
                </div>
                <div class="filter-group">
                    <label>Serial Number:</label>
                    <input type="text" id="filterSerialNumber">
                </div>
                <div class="filter-group">
                    <label>Assigned To:</label>
                    <input type="text" id="filterAssignedTo">
                </div>
            </div>
            <div class="filter-actions">
                <button class="action-button" onclick="App.applyFilters()">Apply Filters</button>
                <button class="action-button" onclick="App.clearFilters()">Clear Filters</button>
            </div>
        </div>

        <div class="search-container">
            <input type="text" id="quickFilter" placeholder="Quick filter..." oninput="App.onQuickFilterChanged()">
        </div>

        <div id="myGrid" class="ag-theme-alpine" style="height: 600px;"></div>

        <div class="pagination">
            <button class="page-button" onclick="App.previousPage()" id="prevButton">Previous</button>
            <span id="pageInfo">Page 1</span>
            <button class="page-button" onclick="App.nextPage()" id="nextButton">Next</button>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="App.closeDetailsModal()">&times;</span>
            <h2>Hardware Details</h2>
            <div class="details-grid">
                <div class="details-item">
                    <div class="details-label">Site Name</div>
                    <div class="details-value" id="detailSiteName"></div>
                </div>
                <div class="details-item">
                    <div class="details-label">Room Number</div>
                    <div class="details-value" id="detailRoomNumber"></div>
                </div>
                <div class="details-item">
                    <div class="details-label">Room Name</div>
                    <div class="details-value" id="detailRoomName"></div>
                </div>
                <div class="details-item">
                    <div class="details-label">Asset Tag</div>
                    <div class="details-value" id="detailAssetTag"></div>
                </div>
                <div class="details-item">
                    <div class="details-label">Asset Type</div>
                    <div class="details-value" id="detailAssetType"></div>
                </div>
                <div class="details-item">
                    <div class="details-label">Model</div>
                    <div class="details-value" id="detailModel"></div>
                </div>
                <div class="details-item">
                    <div class="details-label">Serial Number</div>
                    <div class="details-value" id="detailSerialNumber"></div>
                </div>
                <div class="details-item">
                    <div class="details-label">Notes</div>
                    <div class="details-value" id="detailNotes"></div>
                </div>
                <div class="details-item">
                    <div class="details-label">Assigned To</div>
                    <div class="details-value" id="detailAssignedTo"></div>
                </div>
                <div class="details-item">
                    <div class="details-label">Date Assigned</div>
                    <div class="details-value" id="detailDateAssigned"></div>
                </div>
                <div class="details-item">
                    <div class="details-label">Date Decommissioned</div>
                    <div class="details-value" id="detailDateDecommissioned"></div>
                </div>
            </div>
            <div class="details-actions">
                <button class="view-audit-button" id="viewAuditButton">View History</button>
                <button class="edit-button" id="detailsEditButton">Edit</button>
                <button class="loaner-button" id="toggleLoanerButton">Mark as Loaner</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="App.closeEditModal()">&times;</span>
            <h2>Edit Hardware</h2>
            <form id="editForm" onsubmit="App.handleEditSubmit(event)">
                <div class="form-group">
                    <label for="editSiteName">Site Name:</label>
                    <input type="text" id="editSiteName" required>
                </div>
                <div class="form-group">
                    <label for="editRoomNumber">Room Number:</label>
                    <input type="text" id="editRoomNumber" required>
                </div>
                <div class="form-group">
                    <label for="editRoomName">Room Name:</label>
                    <input type="text" id="editRoomName">
                </div>
                <div class="form-group">
                    <label for="editAssetTag">Asset Tag:</label>
                    <input type="text" id="editAssetTag" required>
                </div>
                <div class="form-group">
                    <label for="editAssetType">Asset Type:</label>
                    <input type="text" id="editAssetType" required>
                </div>
                <div class="form-group">
                    <label for="editModel">Model:</label>
                    <input type="text" id="editModel" required>
                </div>
                <div class="form-group">
                    <label for="editSerialNumber">Serial Number:</label>
                    <input type="text" id="editSerialNumber" required>
                </div>
                <div class="form-group">
                    <label for="editNotes">Notes:</label>
                    <textarea id="editNotes"></textarea>
                </div>
                <div class="form-group">
                    <label for="editAssignedTo">Assigned To:</label>
                    <input type="text" id="editAssignedTo">
                </div>
                <div class="form-group">
                    <label for="editDateAssigned">Date Assigned:</label>
                    <input type="date" id="editDateAssigned">
                </div>
                <div class="form-group">
                    <label for="editDateDecommissioned">Date Decommissioned:</label>
                    <input type="date" id="editDateDecommissioned">
                </div>
                <button type="submit" class="action-button">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Audit Log Modal -->
    <div id="auditModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="App.closeAuditModal()">&times;</span>
            <h2>Audit History</h2>
            <div class="audit-container">
                <table class="audit-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Action</th>
                            <th>Field</th>
                            <th>Old Value</th>
                            <th>New Value</th>
                            <th>Changed By</th>
                        </tr>
                    </thead>
                    <tbody id="auditTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const App = {
            grid: null,
            currentPage: 1,
            pageSize: 100,
            currentItem: null,
            rowData: [],
            
            init: function() {
                const columnDefs = [
                    { field: "site_name", headerName: "Site", filter: true },
                    { field: "room_number", headerName: "Room #", filter: true },
                    { field: "room_name", headerName: "Room Name", filter: true },
                    { field: "asset_tag", headerName: "Asset Tag", filter: true },
                    { field: "asset_type", headerName: "Type", filter: true },
                    { field: "model", headerName: "Model", filter: true },
                    { field: "serial_number", headerName: "Serial #", filter: true },
                    { field: "assigned_to", headerName: "Assigned To", filter: true },
                    {
                        headerName: "Actions",
                        cellRenderer: params => {
                            return `
                                <button class="details-button" onclick="App.showDetails(${JSON.stringify(params.data).replace(/"/g, '&quot;')})">Details</button>
                            `;
                        }
                    }
                ];

                const gridOptions = {
                    columnDefs: columnDefs,
                    rowData: [],
                    pagination: true,
                    paginationPageSize: this.pageSize,
                    domLayout: 'autoHeight',
                    defaultColDef: {
                        flex: 1,
                        minWidth: 100,
                        filter: true,
                        sortable: true,
                        resizable: true
                    },
                    onGridReady: () => this.loadInventory(1)
                };

                const gridDiv = document.querySelector('#myGrid');
                this.grid = new agGrid.Grid(gridDiv, gridOptions);
                
                // Check and apply theme
                const theme = localStorage.getItem('theme') || 'light';
                document.body.setAttribute('data-theme', theme);
                this.updateThemeButton(theme);
                
                // Update grid theme
                const gridElement = document.querySelector('#myGrid');
                if (theme === 'dark') {
                    gridElement.classList.remove('ag-theme-alpine');
                    gridElement.classList.add('ag-theme-alpine-dark');
                } else {
                    gridElement.classList.remove('ag-theme-alpine-dark');
                    gridElement.classList.add('ag-theme-alpine');
                }
            },

            loadInventory: async function(page) {
                try {
                    const response = await fetch('/api/hardware');
                    if (!response.ok) throw new Error('Failed to fetch inventory');
                    
                    const data = await response.json();
                    this.rowData = data;
                    
                    const start = (page - 1) * this.pageSize;
                    const end = start + this.pageSize;
                    const pageData = data.slice(start, end);
                    
                    this.grid.gridOptions.api.setRowData(pageData);
                    this.updatePaginationControls(page, data.length);
                    this.currentPage = page;
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error loading inventory');
                }
            },

            showDetails: function(item) {
                this.currentItem = item;
                
                // Update details view
                document.getElementById('detailSiteName').textContent = item.site_name || '';
                document.getElementById('detailRoomNumber').textContent = item.room_number || '';
                document.getElementById('detailRoomName').textContent = item.room_name || '';
                document.getElementById('detailAssetTag').textContent = item.asset_tag || '';
                document.getElementById('detailAssetType').textContent = item.asset_type || '';
                document.getElementById('detailModel').textContent = item.model || '';
                document.getElementById('detailSerialNumber').textContent = item.serial_number || '';
                document.getElementById('detailNotes').textContent = item.notes || '';
                document.getElementById('detailAssignedTo').textContent = item.assigned_to || '';
                document.getElementById('detailDateAssigned').textContent = item.date_assigned ? new Date(item.date_assigned).toLocaleDateString() : '';
                document.getElementById('detailDateDecommissioned').textContent = item.date_decommissioned ? new Date(item.date_decommissioned).toLocaleDateString() : '';
                
                // Update loaner button text
                const loanerButton = document.getElementById('toggleLoanerButton');
                loanerButton.textContent = item.is_loaner ? 'Remove Loaner Status' : 'Mark as Loaner';
                
                // Show the details modal
                document.getElementById('detailsModal').style.display = 'block';
                
                // Set up button click handlers
                document.getElementById('viewAuditButton').onclick = () => this.loadAuditLog(item.asset_tag);
                document.getElementById('detailsEditButton').onclick = () => this.editHardware(item);
                document.getElementById('toggleLoanerButton').onclick = () => this.toggleLoaner(item);
            },

            closeDetailsModal: function() {
                document.getElementById('detailsModal').style.display = 'none';
            },

            toggleLoaner: async function(item) {
                try {
                    const response = await fetch(`/api/hardware/${item.asset_tag}/toggle-loaner`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.error || 'Failed to toggle loaner status');
                    }

                    const result = await response.json();
                    
                    // Update the button text based on the new state
                    const button = document.getElementById('toggleLoanerButton');
                    button.textContent = result.is_loaner ? 'Remove Loaner Status' : 'Mark as Loaner';
                    
                    // Reload the grid to reflect the change
                    this.loadInventory(this.currentPage);
                    
                    alert(result.is_loaner ? 'Marked as loaner' : 'Removed loaner status');
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            },

            loadAuditLog: async function(assetTag) {
                try {
                    const response = await fetch(`/api/hardware/${assetTag}/audit`);
                    if (!response.ok) throw new Error('Failed to fetch audit log');
                    
                    const data = await response.json();
                    const tbody = document.getElementById('auditTableBody');
                    tbody.innerHTML = '';
                    
                    data.forEach(log => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${new Date(log.changed_at).toLocaleString()}</td>
                            <td>${log.action_type}</td>
                            <td>${log.field_name}</td>
                            <td>${log.old_value || ''}</td>
                            <td>${log.new_value || ''}</td>
                            <td>${log.changed_by}</td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    document.getElementById('auditModal').style.display = 'block';
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error loading audit log');
                }
            },

            closeAuditModal: function() {
                document.getElementById('auditModal').style.display = 'none';
            },

            editHardware: function(item) {
                document.getElementById('editSiteName').value = item.site_name || '';
                document.getElementById('editRoomNumber').value = item.room_number || '';
                document.getElementById('editRoomName').value = item.room_name || '';
                document.getElementById('editAssetTag').value = item.asset_tag || '';
                document.getElementById('editAssetType').value = item.asset_type || '';
                document.getElementById('editModel').value = item.model || '';
                document.getElementById('editSerialNumber').value = item.serial_number || '';
                document.getElementById('editNotes').value = item.notes || '';
                document.getElementById('editAssignedTo').value = item.assigned_to || '';
                document.getElementById('editDateAssigned').value = item.date_assigned ? item.date_assigned.split('T')[0] : '';
                document.getElementById('editDateDecommissioned').value = item.date_decommissioned ? item.date_decommissioned.split('T')[0] : '';
                
                document.getElementById('editModal').style.display = 'block';
            },

            closeEditModal: function() {
                document.getElementById('editModal').style.display = 'none';
            },

            handleEditSubmit: async function(event) {
                event.preventDefault();
                
                const formData = {
                    site_name: document.getElementById('editSiteName').value,
                    room_number: document.getElementById('editRoomNumber').value,
                    room_name: document.getElementById('editRoomName').value,
                    asset_tag: document.getElementById('editAssetTag').value,
                    asset_type: document.getElementById('editAssetType').value,
                    model: document.getElementById('editModel').value,
                    serial_number: document.getElementById('editSerialNumber').value,
                    notes: document.getElementById('editNotes').value,
                    assigned_to: document.getElementById('editAssignedTo').value,
                    date_assigned: document.getElementById('editDateAssigned').value || null,
                    date_decommissioned: document.getElementById('editDateDecommissioned').value || null
                };
                
                try {
                    const response = await fetch(`/api/hardware/${this.currentItem.asset_tag}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });

                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.error || 'Failed to update hardware');
                    }

                    this.closeEditModal();
                    this.loadInventory(this.currentPage);
                    alert('Hardware updated successfully');
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            },

            updatePaginationControls: function(currentPage, totalItems) {
                const totalPages = Math.ceil(totalItems / this.pageSize);
                document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
                document.getElementById('prevButton').disabled = currentPage === 1;
                document.getElementById('nextButton').disabled = currentPage === totalPages;
            },

            previousPage: function() {
                if (this.currentPage > 1) {
                    this.loadInventory(this.currentPage - 1);
                }
            },

            nextPage: function() {
                const totalPages = Math.ceil(this.rowData.length / this.pageSize);
                if (this.currentPage < totalPages) {
                    this.loadInventory(this.currentPage + 1);
                }
            },

            toggleTheme: function() {
                const body = document.body;
                const currentTheme = body.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                body.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                
                // Update grid theme
                const gridElement = document.querySelector('#myGrid');
                if (newTheme === 'dark') {
                    gridElement.classList.remove('ag-theme-alpine');
                    gridElement.classList.add('ag-theme-alpine-dark');
                } else {
                    gridElement.classList.remove('ag-theme-alpine-dark');
                    gridElement.classList.add('ag-theme-alpine');
                }
                
                this.updateThemeButton(newTheme);
            },

            updateThemeButton: function(theme) {
                const button = document.querySelector('.theme-toggle');
                const icon = button.querySelector('.theme-icon');
                const text = button.querySelector('.theme-text');
                
                if (theme === 'dark') {
                    icon.textContent = '☀️';
                    text.textContent = 'Light Mode';
                } else {
                    icon.textContent = '🌙';
                    text.textContent = 'Dark Mode';
                }
            },

            toggleFilterPanel: function() {
                const panel = document.getElementById('filterPanel');
                panel.classList.toggle('active');
            },

            applyFilters: function() {
                const filters = {
                    site_name: document.getElementById('filterSiteName').value,
                    room_number: document.getElementById('filterRoomNumber').value,
                    asset_tag: document.getElementById('filterAssetTag').value,
                    asset_type: document.getElementById('filterAssetType').value,
                    model: document.getElementById('filterModel').value,
                    serial_number: document.getElementById('filterSerialNumber').value,
                    assigned_to: document.getElementById('filterAssignedTo').value
                };
                
                const filteredData = this.rowData.filter(item => {
                    return Object.entries(filters).every(([key, value]) => {
                        if (!value) return true;
                        return item[key] && item[key].toLowerCase().includes(value.toLowerCase());
                    });
                });
                
                this.grid.gridOptions.api.setRowData(filteredData);
                this.updatePaginationControls(1, filteredData.length);
            },

            clearFilters: function() {
                const filterInputs = document.querySelectorAll('.filter-group input');
                filterInputs.forEach(input => input.value = '');
                this.loadInventory(1);
            },

            onQuickFilterChanged: function() {
                const value = document.getElementById('quickFilter').value;
                this.grid.gridOptions.api.setQuickFilter(value);
            }
        };

        document.addEventListener('DOMContentLoaded', () => App.init());

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.getElementsByClassName('modal');
            for (let modal of modals) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            }
        };
    </script>
</body>
</html>
