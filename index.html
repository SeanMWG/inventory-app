<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Hardware Inventory</title>
    <link rel="stylesheet" href="static/styles.css">
    <!-- AG Grid Community Edition -->
    <link href="https://cdn.jsdelivr.net/npm/ag-grid-community@29.3.5/styles/ag-grid.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/ag-grid-community@29.3.5/styles/ag-theme-alpine.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/ag-grid-community@29.3.5/styles/ag-theme-alpine-dark.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@29.3.5/dist/ag-grid-community.min.js"></script>
</head>
<body>
    <!-- Previous HTML content remains the same until the details modal -->

    <!-- Details Modal -->
    <div id="detailsModal" class="details-modal">
        <div class="details-content">
            <span class="close">&times;</span>
            <h2>Hardware Details</h2>
            <div class="details-grid">
                <!-- Previous details grid content remains the same -->
            </div>
            <div class="details-actions">
                <button class="view-audit-button" id="viewAuditButton">View History</button>
                <button class="edit-button" id="detailsEditButton">Edit</button>
            </div>
        </div>
    </div>

    <!-- Audit Log Modal -->
    <div id="auditModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Change History</h2>
            <div class="audit-container">
                <table class="audit-table">
                    <thead>
                        <tr>
                            <th>Date/Time</th>
                            <th>Action</th>
                            <th>Field</th>
                            <th>Old Value</th>
                            <th>New Value</th>
                            <th>Changed By</th>
                        </tr>
                    </thead>
                    <tbody id="auditTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Previous JavaScript remains the same until the showDetails function

        // Show details modal
        function showDetails(item) {
            currentItem = item;
            document.getElementById('detailSiteName').textContent = item.site_name;
            document.getElementById('detailRoomNumber').textContent = item.room_number;
            document.getElementById('detailRoomName').textContent = item.room_name;
            document.getElementById('detailAssetTag').textContent = item.asset_tag;
            document.getElementById('detailAssetType').textContent = item.asset_type;
            document.getElementById('detailModel').textContent = item.model;
            document.getElementById('detailSerialNumber').textContent = item.serial_number;
            document.getElementById('detailNotes').textContent = item.notes || '';
            document.getElementById('detailAssignedTo').textContent = item.assigned_to || '';
            document.getElementById('detailDateAssigned').textContent = item.date_assigned ? new Date(item.date_assigned).toLocaleDateString() : '';
            document.getElementById('detailDateDecommissioned').textContent = item.date_decommissioned ? new Date(item.date_decommissioned).toLocaleDateString() : '';
            
            // Show/hide edit button based on permissions
            const editButton = document.getElementById('detailsEditButton');
            editButton.style.display = userPermissions.includes('edit') ? 'block' : 'none';
            editButton.onclick = () => editHardware(item);

            // Set up audit button
            const auditButton = document.getElementById('viewAuditButton');
            auditButton.onclick = () => showAuditLog(item.asset_tag);
            
            document.getElementById('detailsModal').style.display = 'block';
        }

        // Show audit log
        async function showAuditLog(assetTag) {
            try {
                const response = await fetch(`/api/audit/${assetTag}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const auditEntries = await response.json();
                
                const tbody = document.getElementById('auditTableBody');
                tbody.innerHTML = '';
                
                auditEntries.forEach(entry => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(entry.changed_at).toLocaleString()}</td>
                        <td>${entry.action_type}</td>
                        <td>${entry.field_name}</td>
                        <td>${entry.old_value || ''}</td>
                        <td>${entry.new_value || ''}</td>
                        <td>${entry.changed_by}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                document.getElementById('auditModal').style.display = 'block';
            } catch (error) {
                console.error('Error loading audit log:', error);
                alert('Error loading change history');
            }
        }

        // Rest of the JavaScript remains the same
    </script>
</body>
</html>
